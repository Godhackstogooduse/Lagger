local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer

-- UI Parent Selection
local parentUI = player:WaitForChild("PlayerGui")
local success, coreGui = pcall(function() return game:GetService("CoreGui") end)
if success and coreGui then parentUI = coreGui end

-- HELPER: Create UI Objects
local function create(class, props)
	local inst = Instance.new(class)
	for i, v in pairs(props) do inst[i] = v end
	return inst
end

-- MAIN CONTAINER
local screenGui = create("ScreenGui", {Name = "EliteUtilityV5", ResetOnSpawn = false, Parent = parentUI})
local main = create("Frame", {
	Size = UDim2.new(0, 260, 0, 320),
	Position = UDim2.new(0.5, -130, 0.4, 0),
	BackgroundColor3 = Color3.fromRGB(25, 25, 25),
	BorderSizePixel = 0,
	Active = true,
	Draggable = true,
	Parent = screenGui
})
create("UICorner", {CornerRadius = UDim.new(0, 12), Parent = main})
create("UIStroke", {Color = Color3.fromRGB(60, 60, 60), Thickness = 2, Parent = main})

-- TOP BAR / TITLE
local topBar = create("Frame", {
	Size = UDim2.new(1, 0, 0, 40),
	BackgroundColor3 = Color3.fromRGB(35, 35, 35),
	BorderSizePixel = 0,
	Parent = main
})
create("UICorner", {CornerRadius = UDim.new(0, 12), Parent = topBar})
create("TextLabel", {
	Size = UDim2.new(1, 0, 1, 0),
	Text = "ELITE MOD HUB",
	TextColor3 = Color3.fromRGB(255, 255, 255),
	Font = Enum.Font.GothamBold,
	TextSize = 14,
	BackgroundTransparency = 1,
	Parent = topBar
})

-- SPEED SECTION
create("TextLabel", {
	Size = UDim2.new(1, -20, 0, 20),
	Position = UDim2.new(0, 10, 0, 50),
	Text = "SPEED BOOSTER",
	TextColor3 = Color3.fromRGB(150, 150, 150),
	Font = Enum.Font.GothamBold,
	TextSize = 12,
	BackgroundTransparency = 1,
	TextXAlignment = "Left",
	Parent = main
})

local speedInput = create("TextBox", {
	Size = UDim2.new(0.9, 0, 0, 35),
	Position = UDim2.new(0.05, 0, 0, 75),
	BackgroundColor3 = Color3.fromRGB(40, 40, 40),
	Text = "16",
	TextColor3 = Color3.new(1, 1, 1),
	Font = Enum.Font.Gotham,
	PlaceholderText = "Enter Speed...",
	Parent = main
})
create("UICorner", {CornerRadius = UDim.new(0, 6), Parent = speedInput})

-- PACKET SECTION
create("TextLabel", {
	Size = UDim2.new(1, -20, 0, 20),
	Position = UDim2.new(0, 10, 0, 120),
	Text = "PACKET INTENSITY (LAG)",
	TextColor3 = Color3.fromRGB(150, 150, 150),
	Font = Enum.Font.GothamBold,
	TextSize = 12,
	BackgroundTransparency = 1,
	TextXAlignment = "Left",
	Parent = main
})

-- SLIDER SYSTEM
local sliderBg = create("Frame", {
	Size = UDim2.new(0.9, 0, 0, 6),
	Position = UDim2.new(0.05, 0, 0, 155),
	BackgroundColor3 = Color3.fromRGB(50, 50, 50),
	BorderSizePixel = 0,
	Parent = main
})
create("UICorner", {CornerRadius = UDim.new(1, 0), Parent = sliderBg})

local sliderFill = create("Frame", {
	Size = UDim2.new(0, 0, 1, 0),
	BackgroundColor3 = Color3.fromRGB(120, 80, 255),
	BorderSizePixel = 0,
	Parent = sliderBg
})
create("UICorner", {CornerRadius = UDim.new(1, 0), Parent = sliderFill})

local knob = create("Frame", {
	Size = UDim2.new(0, 16, 0, 16),
	Position = UDim2.new(0, -8, 0.5, -8),
	BackgroundColor3 = Color3.fromRGB(255, 255, 255),
	Parent = sliderFill
})
create("UICorner", {CornerRadius = UDim.new(1, 0), Parent = knob})

local intensityLabel = create("TextLabel", {
	Size = UDim2.new(1, 0, 0, 20),
	Position = UDim2.new(0, 0, 0, 165),
	Text = "Intensity: 0%",
	TextColor3 = Color3.fromRGB(120, 80, 255),
	Font = Enum.Font.GothamBold,
	TextSize = 12,
	BackgroundTransparency = 1,
	Parent = main
})

-- BUTTONS
local floodToggle = create("TextButton", {
	Size = UDim2.new(0.9, 0, 0, 40),
	Position = UDim2.new(0.05, 0, 0, 200),
	BackgroundColor3 = Color3.fromRGB(180, 50, 50),
	Text = "FLOOD PACKETS: OFF",
	TextColor3 = Color3.new(1, 1, 1),
	Font = Enum.Font.GothamBold,
	Parent = main
})
create("UICorner", {CornerRadius = UDim.new(0, 8), Parent = floodToggle})

local resyncBtn = create("TextButton", {
	Size = UDim2.new(0.9, 0, 0, 40),
	Position = UDim2.new(0.05, 0, 0, 250),
	BackgroundColor3 = Color3.fromRGB(50, 150, 50),
	Text = "RESYNC CONNECTION",
	TextColor3 = Color3.new(1, 1, 1),
	Font = Enum.Font.GothamBold,
	Parent = main
})
create("UICorner", {CornerRadius = UDim.new(0, 8), Parent = resyncBtn})

-- LOGIC: SLIDER
local dragging = false
local intensityPercent = 0

local function updateSlider()
	local mousePos = UIS:GetMouseLocation().X
	local sliderPos = sliderBg.AbsolutePosition.X
	local sliderWidth = sliderBg.AbsoluteSize.X
	local percent = math.clamp((mousePos - sliderPos) / sliderWidth, 0, 1)
	
	intensityPercent = percent
	sliderFill.Size = UDim2.new(percent, 0, 1, 0)
	intensityLabel.Text = "Intensity: " .. math.floor(percent * 100) .. "%"
	
	-- Apply Lag (Max 15 seconds)
	if not floodActive then
		settings().Network.IncomingReplicationLag = percent * 15
	end
end

knob.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = true end
end)
UIS.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
end)
UIS.InputChanged:Connect(function(input)
	if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
		updateSlider()
	end
end)

-- LOGIC: PACKET FLOOD
local floodActive = false
floodToggle.MouseButton1Click:Connect(function()
	floodActive = not floodActive
	if floodActive then
		floodToggle.Text = "FLOOD PACKETS: ON"
		floodToggle.BackgroundColor3 = Color3.fromRGB(50, 180, 50)
		settings().Network.IncomingReplicationLag = 9e9 -- Freeze effectively
	else
		floodToggle.Text = "FLOOD PACKETS: OFF"
		floodToggle.BackgroundColor3 = Color3.fromRGB(180, 50, 50)
		settings().Network.IncomingReplicationLag = intensityPercent * 15
	end
end)

-- LOGIC: SPEED & RESYNC
resyncBtn.MouseButton1Click:Connect(function()
	local char = player.Character
	if char and char:FindFirstChild("Humanoid") then
		char.Humanoid.WalkSpeed = tonumber(speedInput.Text) or 16
	end
	settings().Network.IncomingReplicationLag = 0
	intensityPercent = 0
	sliderFill.Size = UDim2.new(0,0,1,0)
	intensityLabel.Text = "Intensity: 0% (Resynced)"
end)

speedInput.FocusLost:Connect(function()
	local char = player.Character
	if char and char:FindFirstChild("Humanoid") then
		char.Humanoid.WalkSpeed = tonumber(speedInput.Text) or 16
	end
end)
