local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer

-- UI Parent (CoreGui for consistency)
local parentUI = (game:GetService("CoreGui") or player:WaitForChild("PlayerGui"))

-- CLEANUP OLD VERSIONS
if parentUI:FindFirstChild("AbyssFinal") then parentUI.AbyssFinal:Destroy() end

-- GLOBAL SETTINGS (Persists through death)
_G.AbyssSpeed = 16
_G.AbyssLagValue = 0
_G.LagEnabled = false

-- UI SETUP (ResetOnSpawn = false means it never goes away)
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AbyssFinal"
screenGui.ResetOnSpawn = false 
screenGui.Parent = parentUI

local main = Instance.new("Frame")
main.Size = UDim2.new(0, 240, 0, 300)
main.Position = UDim2.new(1, -260, 0.5, -150) -- FIXED MIDDLE RIGHT
main.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
main.BorderSizePixel = 0
main.Active = true
main.Parent = screenGui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 10)
corner.Parent = main

local stroke = Instance.new("UIStroke")
stroke.Thickness = 2
stroke.Color = Color3.fromRGB(100, 50, 255)
stroke.Parent = main

-- TITLE
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 45)
title.Text = "ABYSS V9 [STABLE]"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
title.Font = Enum.Font.GothamBold
title.TextSize = 14
title.Parent = main

-- 1. SPEED INPUT
local speedLabel = Instance.new("TextLabel")
speedLabel.Size = UDim2.new(1, -20, 0, 20)
speedLabel.Position = UDim2.new(0, 10, 0, 55)
speedLabel.Text = "SET SPEED:"
speedLabel.TextColor3 = Color3.new(0.6, 0.6, 0.6)
speedLabel.BackgroundTransparency = 1
speedLabel.Font = Enum.Font.GothamBold
speedLabel.TextSize = 10
speedLabel.TextXAlignment = "Left"
speedLabel.Parent = main

local speedBox = Instance.new("TextBox")
speedBox.Size = UDim2.new(0.9, 0, 0, 35)
speedBox.Position = UDim2.new(0.05, 0, 0, 75)
speedBox.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
speedBox.Text = tostring(_G.AbyssSpeed)
speedBox.TextColor3 = Color3.new(1, 1, 1)
speedBox.Font = Enum.Font.Gotham
speedBox.Parent = main
Instance.new("UICorner", speedBox).CornerRadius = UDim.new(0, 6)

-- 2. LAG TOGGLE BUTTON
local lagToggle = Instance.new("TextButton")
lagToggle.Size = UDim2.new(0.9, 0, 0, 45)
lagToggle.Position = UDim2.new(0.05, 0, 0, 125)
lagToggle.BackgroundColor3 = Color3.fromRGB(180, 50, 50)
lagToggle.Text = "ACTIVATE LAG: OFF"
lagToggle.TextColor3 = Color3.new(1, 1, 1)
lagToggle.Font = Enum.Font.GothamBold
lagToggle.Parent = main
Instance.new("UICorner", lagToggle).CornerRadius = UDim.new(0, 6)

-- 3. LAG INTENSITY SLIDER
local lagLabel = Instance.new("TextLabel")
lagLabel.Size = UDim2.new(1, -20, 0, 20)
lagLabel.Position = UDim2.new(0, 10, 0, 180)
lagLabel.Text = "INTENSITY: 0%"
lagLabel.TextColor3 = Color3.fromRGB(150, 150, 255)
lagLabel.BackgroundTransparency = 1
lagLabel.Font = Enum.Font.GothamBold
lagLabel.TextSize = 10
lagLabel.TextXAlignment = "Left"
lagLabel.Parent = main

local sliderFrame = Instance.new("Frame")
sliderFrame.Size = UDim2.new(0.85, 0, 0, 8)
sliderFrame.Position = UDim2.new(0.075, 0, 0, 205)
sliderFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
sliderFrame.Parent = main

local sliderFill = Instance.new("Frame")
sliderFill.Size = UDim2.new(0, 0, 1, 0)
sliderFill.BackgroundColor3 = Color3.fromRGB(100, 50, 255)
sliderFill.BorderSizePixel = 0
sliderFill.Parent = sliderFrame

local knob = Instance.new("TextButton")
knob.Size = UDim2.new(0, 16, 0, 16)
knob.Position = UDim2.new(0, -8, 0.5, -8)
knob.BackgroundColor3 = Color3.new(1, 1, 1)
knob.Text = ""
knob.Parent = sliderFill
Instance.new("UICorner", knob).CornerRadius = UDim.new(1, 0)

-- LOGIC: SLIDER
local sliding = false
local function updateLag()
    if _G.LagEnabled then
        settings().Network.IncomingReplicationLag = _G.AbyssLagValue
    else
        settings().Network.IncomingReplicationLag = 0
    end
end

knob.MouseButton1Down:Connect(function() sliding = true end)
UIS.InputEnded:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 then sliding = false end end)

UIS.InputChanged:Connect(function(input)
    if sliding and input.UserInputType == Enum.UserInputType.MouseMovement then
        local mousePos = UIS:GetMouseLocation().X
		local framePos = sliderFrame.AbsolutePosition.X
		local frameWidth = sliderFrame.AbsoluteSize.X
		local percentage = math.clamp((mousePos - framePos) / frameWidth, 0, 1)
        
        sliderFill.Size = UDim2.new(percentage, 0, 1, 0)
        lagLabel.Text = "INTENSITY: " .. math.floor(percentage * 100) .. "%"
        _G.AbyssLagValue = percentage * 20 -- Max 20-second delay for stability
        updateLag()
    end
end)

-- LOGIC: TOGGLE CLICK
lagToggle.MouseButton1Click:Connect(function()
    _G.LagEnabled = not _G.LagEnabled
    lagToggle.Text = _G.LagEnabled and "ACTIVATE LAG: ON" or "ACTIVATE LAG: OFF"
    lagToggle.BackgroundColor3 = _G.LagEnabled and Color3.fromRGB(50, 180, 50) or Color3.fromRGB(180, 50, 50)
    updateLag()
end)

-- LOGIC: SPEED & PERSISTENCE
speedBox.FocusLost:Connect(function()
    _G.AbyssSpeed = tonumber(speedBox.Text) or 16
end)

RunService.RenderStepped:Connect(function()
    local char = player.Character
    if char then
        local hum = char:FindFirstChild("Humanoid")
        if hum then
            hum.WalkSpeed = _G.AbyssSpeed
        end
    end
end)

-- RESET SYNC BUTTON
local resetBtn = Instance.new("TextButton")
resetBtn.Size = UDim2.new(0.9, 0, 0, 35)
resetBtn.Position = UDim2.new(0.05, 0, 0, 245)
resetBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
resetBtn.Text = "EMERGENCY RESYNC"
resetBtn.TextColor3 = Color3.new(1, 1, 1)
resetBtn.Font = Enum.Font.Gotham
resetBtn.Parent = main
resetBtn.MouseButton1Click:Connect(function()
    _G.LagEnabled = false
    _G.AbyssLagValue = 0
    _G.AbyssSpeed = 16
    speedBox.Text = "16"
    lagToggle.Text = "ACTIVATE LAG: OFF"
    lagToggle.BackgroundColor3 = Color3.fromRGB(180, 50, 50)
    sliderFill.Size = UDim2.new(0, 0, 1, 0)
    lagLabel.Text = "INTENSITY: 0%"
    settings().Network.IncomingReplicationLag = 0
end)
