local Players = game:GetService("Players")
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hum = character:WaitForChild("Humanoid")

-- UI Parent Selection
local parentUI = player:WaitForChild("PlayerGui")
local success, coreGui = pcall(function() return game:GetService("CoreGui") end)
if success and coreGui then parentUI = coreGui end

-- MAIN GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ModHubV4"
screenGui.ResetOnSpawn = false
screenGui.Parent = parentUI

local main = Instance.new("Frame")
main.Size = UDim2.new(0, 250, 0, 220)
main.Position = UDim2.new(0.5, -125, 0.4, 0)
main.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
main.BorderSizePixel = 0
main.Active = true
main.Draggable = true
main.Parent = screenGui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 10)
corner.Parent = main

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 35)
title.Text = "UTILITY HUB"
title.TextColor3 = Color3.new(1, 1, 1)
title.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
title.Font = Enum.Font.GothamBold
title.TextSize = 16
title.Parent = main

-- 1. PACKET LAG TOGGLE (Cycles through percentages/intensity)
local lagLevels = {0, 0.2, 0.5, 1, 5} -- 0ms, 200ms, 500ms, 1s, 5s
local currentLagIndex = 1

local lagBtn = Instance.new("TextButton")
lagBtn.Size = UDim2.new(0.9, 0, 0, 40)
lagBtn.Position = UDim2.new(0.05, 0, 0, 45)
lagBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
lagBtn.Text = "Lag: OFF (0ms)"
lagBtn.TextColor3 = Color3.new(1, 1, 1)
lagBtn.Font = Enum.Font.Gotham
lagBtn.TextSize = 14
lagBtn.Parent = main

lagBtn.MouseButton1Click:Connect(function()
    currentLagIndex = currentLagIndex + 1
    if currentLagIndex > #lagLevels then currentLagIndex = 1 end
    
    local val = lagLevels[currentLagIndex]
    settings().Network.IncomingReplicationLag = val
    
    if val == 0 then
        lagBtn.Text = "Lag: OFF (0ms)"
        lagBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    else
        lagBtn.Text = "Lag Intensity: " .. (val * 100) .. "% (".. (val*1000) .."ms)"
        lagBtn.BackgroundColor3 = Color3.fromRGB(180, 100, 50)
    end
end)

-- 2. SPEED BOOSTER
local speedLabel = Instance.new("TextLabel")
speedLabel.Size = UDim2.new(0.5, 0, 0, 30)
speedLabel.Position = UDim2.new(0.05, 0, 0, 100)
speedLabel.Text = "WalkSpeed:"
speedLabel.TextColor3 = Color3.new(1, 1, 1)
speedLabel.BackgroundTransparency = 1
speedLabel.TextXAlignment = Enum.TextXAlignment.Left
speedLabel.Parent = main

local speedInput = Instance.new("TextBox")
speedInput.Size = UDim2.new(0.35, 0, 0, 30)
speedInput.Position = UDim2.new(0.55, 0, 0, 100)
speedInput.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
speedInput.Text = "16"
speedInput.TextColor3 = Color3.new(1, 1, 1)
speedInput.PlaceholderText = "Val"
speedInput.Parent = main

local setSpeedBtn = Instance.new("TextButton")
setSpeedBtn.Size = UDim2.new(0.9, 0, 0, 40)
setSpeedBtn.Position = UDim2.new(0.05, 0, 0, 140)
setSpeedBtn.BackgroundColor3 = Color3.fromRGB(50, 150, 50)
setSpeedBtn.Text = "APPLY SPEED"
setSpeedBtn.TextColor3 = Color3.new(1, 1, 1)
setSpeedBtn.Font = Enum.Font.GothamBold
setSpeedBtn.Parent = main

setSpeedBtn.MouseButton1Click:Connect(function()
    local val = tonumber(speedInput.Text)
    if val and hum then
        hum.WalkSpeed = val
    end
end)

-- BLINK (FAKELAG) TOGGLE
local blinkBtn = Instance.new("TextButton")
blinkBtn.Size = UDim2.new(0.9, 0, 0, 30)
blinkBtn.Position = UDim2.new(0.05, 0, 0, 185)
blinkBtn.BackgroundColor3 = Color3.fromRGB(100, 50, 150)
blinkBtn.Text = "Blink (FakeLag): OFF"
blinkBtn.TextColor3 = Color3.new(1, 1, 1)
blinkBtn.TextSize = 12
blinkBtn.Parent = main

local blinkActive = false
blinkBtn.MouseButton1Click:Connect(function()
    blinkActive = not blinkActive
    if blinkActive then
        blinkBtn.Text = "Blink: ACTIVE"
        settings().Network.IncomingReplicationLag = 9e9
    else
        blinkBtn.Text = "Blink: OFF"
        settings().Network.IncomingReplicationLag = lagLevels[currentLagIndex]
    end
end)

-- AUTO-UPDATE ON SPAWN
player.CharacterAdded:Connect(function(newChar)
    character = newChar
    hum = newChar:WaitForChild("Humanoid")
    hum.WalkSpeed = tonumber(speedInput.Text) or 16
end)
